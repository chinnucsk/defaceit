(function(){var a=this,c=a._,e={},h=Array.prototype,m=Object.prototype,o=h.push,j=h.slice,i=h.concat,s=m.toString,t=m.hasOwnProperty,u=h.forEach,w=h.map,A=h.reduce,B=h.reduceRight,C=h.filter,D=h.every,r=h.some,v=h.indexOf,E=h.lastIndexOf,m=Array.isArray,G=Object.keys,x=Function.prototype.bind,d=function(f){if(f instanceof d)return f;if(!(this instanceof d))return new d(f);this._wrapped=f};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=d),exports._=
d):a._=d;d.VERSION="1.4.2";var n=d.each=d.forEach=function(f,b,a){if(null!=f)if(u&&f.forEach===u)f.forEach(b,a);else if(f.length===+f.length)for(var g=0,c=f.length;g<c&&b.call(a,f[g],g,f)!==e;g++);else for(g in f)if(d.has(f,g)&&b.call(a,f[g],g,f)===e)break};d.map=d.collect=function(f,b,a){var g=[];if(null==f)return g;if(w&&f.map===w)return f.map(b,a);n(f,function(f,d,c){g[g.length]=b.call(a,f,d,c)});return g};d.reduce=d.foldl=d.inject=function(f,b,a,g){var c=2<arguments.length;null==f&&(f=[]);if(A&&
f.reduce===A)return g&&(b=d.bind(b,g)),c?f.reduce(b,a):f.reduce(b);n(f,function(f,d,l){c?a=b.call(g,a,f,d,l):(a=f,c=!0)});if(!c)throw new TypeError("Reduce of empty array with no initial value");return a};d.reduceRight=d.foldr=function(f,b,a,g){var c=2<arguments.length;null==f&&(f=[]);if(B&&f.reduceRight===B)return g&&(b=d.bind(b,g)),c?f.reduceRight(b,a):f.reduceRight(b);var l=f.length;if(l!==+l)var k=d.keys(f),l=k.length;n(f,function(d,e,p){e=k?k[--l]:--l;c?a=b.call(g,a,f[e],e,p):(a=f[e],c=!0)});
if(!c)throw new TypeError("Reduce of empty array with no initial value");return a};d.find=d.detect=function(f,b,a){var g;F(f,function(f,d,c){if(b.call(a,f,d,c))return g=f,!0});return g};d.filter=d.select=function(f,b,a){var g=[];if(null==f)return g;if(C&&f.filter===C)return f.filter(b,a);n(f,function(f,d,c){b.call(a,f,d,c)&&(g[g.length]=f)});return g};d.reject=function(f,b,a){return d.filter(f,function(f,g,d){return!b.call(a,f,g,d)},a)};d.every=d.all=function(f,b,a){b||(b=d.identity);var g=!0;if(null==
f)return g;if(D&&f.every===D)return f.every(b,a);n(f,function(f,d,c){if(!(g=g&&b.call(a,f,d,c)))return e});return!!g};var F=d.some=d.any=function(f,b,a){b||(b=d.identity);var g=!1;if(null==f)return g;if(r&&f.some===r)return f.some(b,a);n(f,function(f,d,c){if(g||(g=b.call(a,f,d,c)))return e});return!!g};d.contains=d.include=function(f,b){return null==f?!1:v&&f.indexOf===v?-1!=f.indexOf(b):F(f,function(f){return f===b})};d.invoke=function(f,b){var a=j.call(arguments,2);return d.map(f,function(f){return(d.isFunction(b)?
b:f[b]).apply(f,a)})};d.pluck=function(f,b){return d.map(f,function(f){return f[b]})};d.where=function(f,b){return d.isEmpty(b)?[]:d.filter(f,function(f){for(var a in b)if(d.has(b,a)&&b[a]!==f[a])return!1;return!0})};d.max=function(f,b,a){if(!b&&d.isArray(f)&&f[0]===+f[0]&&65535>f.length)return Math.max.apply(Math,f);if(!b&&d.isEmpty(f))return-Infinity;var g={computed:-Infinity,value:-Infinity};n(f,function(f,d,c){d=b?b.call(a,f,d,c):f;d>=g.computed&&(g={value:f,computed:d})});return g.value};d.min=
function(f,b,a){if(!b&&d.isArray(f)&&f[0]===+f[0]&&65535>f.length)return Math.min.apply(Math,f);if(!b&&d.isEmpty(f))return Infinity;var g={computed:Infinity,value:Infinity};n(f,function(f,d,c){d=b?b.call(a,f,d,c):f;d<g.computed&&(g={value:f,computed:d})});return g.value};d.shuffle=function(f){var b,a=0,g=[];n(f,function(f){b=d.random(a++);g[a-1]=g[b];g[b]=f});return g};var y=function(f){return d.isFunction(f)?f:function(b){return b[f]}};d.sortBy=function(f,b,a){var g=y(b);return d.pluck(d.map(f,function(f,
b,d){return{value:f,index:b,criteria:g.call(a,f,b,d)}}).sort(function(f,b){var a=f.criteria,g=b.criteria;if(a!==g){if(a>g||void 0===a)return 1;if(a<g||void 0===g)return-1}return f.index<b.index?-1:1}),"value")};var z=function(f,b,a,g){var d={},c=y(b);n(f,function(b,I){var l=c.call(a,b,I,f);g(d,l,b)});return d};d.groupBy=function(f,b,a){return z(f,b,a,function(f,b,a){(d.has(f,b)?f[b]:f[b]=[]).push(a)})};d.countBy=function(f,b,a){return z(f,b,a,function(f,b){d.has(f,b)||(f[b]=0);f[b]++})};d.sortedIndex=
function(f,b,a,g){for(var a=null==a?d.identity:y(a),b=a.call(g,b),c=0,l=f.length;c<l;){var k=c+l>>>1;a.call(g,f[k])<b?c=k+1:l=k}return c};d.toArray=function(f){return!f?[]:f.length===+f.length?j.call(f):d.values(f)};d.size=function(f){return null==f?0:f.length===+f.length?f.length:d.keys(f).length};d.first=d.head=d.take=function(f,b,a){return null==f?void 0:null!=b&&!a?j.call(f,0,b):f[0]};d.initial=function(f,b,a){return j.call(f,0,f.length-(null==b||a?1:b))};d.last=function(f,b,a){return null==f?
void 0:null!=b&&!a?j.call(f,Math.max(f.length-b,0)):f[f.length-1]};d.rest=d.tail=d.drop=function(f,b,a){return j.call(f,null==b||a?1:b)};d.compact=function(f){return d.filter(f,function(f){return!!f})};var b=function(f,a,g){n(f,function(f){d.isArray(f)?a?o.apply(g,f):b(f,a,g):g.push(f)});return g};d.flatten=function(f,a){return b(f,a,[])};d.without=function(f){return d.difference(f,j.call(arguments,1))};d.uniq=d.unique=function(f,b,a,g){d.isFunction(b)&&(g=a,a=b,b=!1);var a=a?d.map(f,a,g):f,c=[],
l=[];n(a,function(a,g){if(b?!g||l[l.length-1]!==a:!d.contains(l,a)){l.push(a);c.push(f[g])}});return c};d.union=function(){return d.uniq(i.apply(h,arguments))};d.intersection=function(f){var b=j.call(arguments,1);return d.filter(d.uniq(f),function(f){return d.every(b,function(b){return 0<=d.indexOf(b,f)})})};d.difference=function(f){var b=i.apply(h,j.call(arguments,1));return d.filter(f,function(f){return!d.contains(b,f)})};d.zip=function(){for(var f=j.call(arguments),b=d.max(d.pluck(f,"length")),
a=Array(b),g=0;g<b;g++)a[g]=d.pluck(f,""+g);return a};d.object=function(b,a){if(null==b)return{};for(var g={},d=0,c=b.length;d<c;d++)a?g[b[d]]=a[d]:g[b[d][0]]=b[d][1];return g};d.indexOf=function(b,a,g){if(null==b)return-1;var c=0,l=b.length;if(g)if("number"==typeof g)c=0>g?Math.max(0,l+g):g;else return c=d.sortedIndex(b,a),b[c]===a?c:-1;if(v&&b.indexOf===v)return b.indexOf(a,g);for(;c<l;c++)if(b[c]===a)return c;return-1};d.lastIndexOf=function(b,a,g){if(null==b)return-1;var d=null!=g;if(E&&b.lastIndexOf===
E)return d?b.lastIndexOf(a,g):b.lastIndexOf(a);for(g=d?g:b.length;g--;)if(b[g]===a)return g;return-1};d.range=function(b,a,g){1>=arguments.length&&(a=b||0,b=0);for(var g=arguments[2]||1,d=Math.max(Math.ceil((a-b)/g),0),c=0,l=Array(d);c<d;)l[c++]=b,b+=g;return l};var g=function(){};d.bind=function(b,a){var c,l;if(b.bind===x&&x)return x.apply(b,j.call(arguments,1));if(!d.isFunction(b))throw new TypeError;l=j.call(arguments,2);return c=function(){if(!(this instanceof c))return b.apply(a,l.concat(j.call(arguments)));
g.prototype=b.prototype;var d=new g,k=b.apply(d,l.concat(j.call(arguments)));return Object(k)===k?k:d}};d.bindAll=function(b){var a=j.call(arguments,1);0==a.length&&(a=d.functions(b));n(a,function(a){b[a]=d.bind(b[a],b)});return b};d.memoize=function(b,a){var g={};a||(a=d.identity);return function(){var c=a.apply(this,arguments);return d.has(g,c)?g[c]:g[c]=b.apply(this,arguments)}};d.delay=function(b,a){var g=j.call(arguments,2);return setTimeout(function(){return b.apply(null,g)},a)};d.defer=function(b){return d.delay.apply(d,
[b,1].concat(j.call(arguments,1)))};d.throttle=function(b,a){var g,d,c,l,k=0,e=function(){k=new Date;c=null;l=b.apply(g,d)};return function(){var p=new Date,i=a-(p-k);g=this;d=arguments;0>=i?(clearTimeout(c),k=p,l=b.apply(g,d)):c||(c=setTimeout(e,i));return l}};d.debounce=function(b,a,g){var d,c;return function(){var l=this,k=arguments,e=g&&!d;clearTimeout(d);d=setTimeout(function(){d=null;g||(c=b.apply(l,k))},a);e&&(c=b.apply(l,k));return c}};d.once=function(b){var a=!1,g;return function(){if(a)return g;
a=!0;g=b.apply(this,arguments);b=null;return g}};d.wrap=function(b,a){return function(){var g=[b];o.apply(g,arguments);return a.apply(this,g)}};d.compose=function(){var b=arguments;return function(){for(var a=arguments,g=b.length-1;0<=g;g--)a=[b[g].apply(this,a)];return a[0]}};d.after=function(b,a){return 0>=b?a():function(){if(1>--b)return a.apply(this,arguments)}};d.keys=G||function(b){if(b!==Object(b))throw new TypeError("Invalid object");var a=[],g;for(g in b)d.has(b,g)&&(a[a.length]=g);return a};
d.values=function(b){var a=[],g;for(g in b)d.has(b,g)&&a.push(b[g]);return a};d.pairs=function(b){var a=[],g;for(g in b)d.has(b,g)&&a.push([g,b[g]]);return a};d.invert=function(b){var a={},g;for(g in b)d.has(b,g)&&(a[b[g]]=g);return a};d.functions=d.methods=function(b){var a=[],g;for(g in b)d.isFunction(b[g])&&a.push(g);return a.sort()};d.extend=function(b){n(j.call(arguments,1),function(a){for(var g in a)b[g]=a[g]});return b};d.pick=function(b){var a={},g=i.apply(h,j.call(arguments,1));n(g,function(g){g in
b&&(a[g]=b[g])});return a};d.omit=function(b){var a={},g=i.apply(h,j.call(arguments,1)),c;for(c in b)d.contains(g,c)||(a[c]=b[c]);return a};d.defaults=function(b){n(j.call(arguments,1),function(a){for(var g in a)null==b[g]&&(b[g]=a[g])});return b};d.clone=function(b){return!d.isObject(b)?b:d.isArray(b)?b.slice():d.extend({},b)};d.tap=function(b,a){a(b);return b};var l=function(b,a,g,c){if(b===a)return 0!==b||1/b==1/a;if(null==b||null==a)return b===a;b instanceof d&&(b=b._wrapped);a instanceof d&&
(a=a._wrapped);var k=s.call(b);if(k!=s.call(a))return!1;switch(k){case "[object String]":return b==""+a;case "[object Number]":return b!=+b?a!=+a:0==b?1/b==1/a:b==+a;case "[object Date]":case "[object Boolean]":return+b==+a;case "[object RegExp]":return b.source==a.source&&b.global==a.global&&b.multiline==a.multiline&&b.ignoreCase==a.ignoreCase}if("object"!=typeof b||"object"!=typeof a)return!1;for(var e=g.length;e--;)if(g[e]==b)return c[e]==a;g.push(b);c.push(a);var e=0,p=!0;if("[object Array]"==
k){if(e=b.length,p=e==a.length)for(;e--&&(p=l(b[e],a[e],g,c)););}else{var k=b.constructor,i=a.constructor;if(k!==i&&(!d.isFunction(k)||!(k instanceof k&&d.isFunction(i)&&i instanceof i)))return!1;for(var h in b)if(d.has(b,h)&&(e++,!(p=d.has(a,h)&&l(b[h],a[h],g,c))))break;if(p){for(h in a)if(d.has(a,h)&&!e--)break;p=!e}}g.pop();c.pop();return p};d.isEqual=function(b,a){return l(b,a,[],[])};d.isEmpty=function(b){if(null==b)return!0;if(d.isArray(b)||d.isString(b))return 0===b.length;for(var a in b)if(d.has(b,
a))return!1;return!0};d.isElement=function(b){return!!(b&&1===b.nodeType)};d.isArray=m||function(b){return"[object Array]"==s.call(b)};d.isObject=function(b){return b===Object(b)};n("Arguments,Function,String,Number,Date,RegExp".split(","),function(b){d["is"+b]=function(a){return s.call(a)=="[object "+b+"]"}});d.isArguments(arguments)||(d.isArguments=function(b){return!(!b||!d.has(b,"callee"))});"function"!==typeof/./&&(d.isFunction=function(b){return"function"===typeof b});d.isFinite=function(b){return isFinite(b)&&
!isNaN(parseFloat(b))};d.isNaN=function(b){return d.isNumber(b)&&b!=+b};d.isBoolean=function(b){return!0===b||!1===b||"[object Boolean]"==s.call(b)};d.isNull=function(b){return null===b};d.isUndefined=function(b){return void 0===b};d.has=function(b,a){return t.call(b,a)};d.noConflict=function(){a._=c;return this};d.identity=function(b){return b};d.times=function(b,a,g){for(var d=0;d<b;d++)a.call(g,d)};d.random=function(b,a){null==a&&(a=b,b=0);return b+(0|Math.random()*(a-b+1))};var k={escape:{"&":"&amp;",
"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};k.unescape=d.invert(k.escape);var p={escape:RegExp("["+d.keys(k.escape).join("")+"]","g"),unescape:RegExp("("+d.keys(k.unescape).join("|")+")","g")};d.each(["escape","unescape"],function(b){d[b]=function(a){return null==a?"":(""+a).replace(p[b],function(a){return k[b][a]})}});d.result=function(b,a){if(null==b)return null;var g=b[a];return d.isFunction(g)?g.call(b):g};d.mixin=function(b){n(d.functions(b),function(a){var g=d[a]=b[a];d.prototype[a]=
function(){var b=[this._wrapped];o.apply(b,arguments);b=g.apply(d,b);return this._chain?d(b).chain():b}})};var J=0;d.uniqueId=function(b){var a=J++;return b?b+a:a};d.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var H=/(.)^/,K={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028","\u2029":"u2029"},L=/\\|'|\r|\n|\t|\u2028|\u2029/g;d.template=function(b,a,g){var g=d.defaults({},g,d.templateSettings),c=RegExp([(g.escape||H).source,(g.interpolate||
H).source,(g.evaluate||H).source].join("|")+"|$","g"),l=0,k="__p+='";b.replace(c,function(a,g,d,c,e){k+=b.slice(l,e).replace(L,function(b){return"\\"+K[b]});k+=g?"'+\n((__t=("+g+"))==null?'':_.escape(__t))+\n'":d?"'+\n((__t=("+d+"))==null?'':__t)+\n'":c?"';\n"+c+"\n__p+='":"";l=e+a.length});k+="';\n";g.variable||(k="with(obj||{}){\n"+k+"}\n");k="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+k+"return __p;\n";try{var e=new Function(g.variable||"obj","_",
k)}catch(p){throw p.source=k,p;}if(a)return e(a,d);a=function(b){return e.call(this,b,d)};a.source="function("+(g.variable||"obj")+"){\n"+k+"}";return a};d.chain=function(b){return d(b).chain()};d.mixin(d);n("pop,push,reverse,shift,sort,splice,unshift".split(","),function(b){var a=h[b];d.prototype[b]=function(){var g=this._wrapped;a.apply(g,arguments);(b=="shift"||b=="splice")&&g.length===0&&delete g[0];return this._chain?d(g).chain():g}});n(["concat","join","slice"],function(b){var a=h[b];d.prototype[b]=
function(){var b=a.apply(this._wrapped,arguments);return this._chain?d(b).chain():b}});d.extend(d.prototype,{chain:function(){this._chain=!0;return this},value:function(){return this._wrapped}})}).call(this);
(function(){var a=this,c=a.Backbone,e=Array.prototype,h=e.push,m=e.slice,o=e.splice,j;j="undefined"!==typeof exports?exports:a.Backbone={};j.VERSION="0.9.2";var i=a._;!i&&"undefined"!==typeof require&&(i=require("underscore"));j.$=a.jQuery||a.Zepto||a.ender;j.noConflict=function(){a.Backbone=c;return this};j.emulateHTTP=!1;j.emulateJSON=!1;var s=/\s+/,e=j.Events={on:function(b,a,d){var c,e;if(!a)return this;b=b.split(s);for(c=this._callbacks||(this._callbacks={});e=b.shift();)e=c[e]||(c[e]=[]),e.push(a,
d);return this},off:function(b,a,d){var c,e,h;if(!(e=this._callbacks))return this;if(!b&&!a&&!d)return delete this._callbacks,this;for(b=b?b.split(s):i.keys(e);c=b.shift();)if(!(h=e[c])||!a&&!d)delete e[c];else for(c=h.length-2;0<=c;c-=2)a&&h[c]!==a||d&&h[c+1]!==d||h.splice(c,2);return this},trigger:function(b){var a,d,c,e,i,h,j;if(!(d=this._callbacks))return this;j=[];b=b.split(s);e=1;for(i=arguments.length;e<i;e++)j[e-1]=arguments[e];for(;a=b.shift();){if(h=d.all)h=h.slice();if(c=d[a])c=c.slice();
if(c){e=0;for(i=c.length;e<i;e+=2)c[e].apply(c[e+1]||this,j)}if(h){a=[a].concat(j);e=0;for(i=h.length;e<i;e+=2)h[e].apply(h[e+1]||this,a)}}return this}};e.bind=e.on;e.unbind=e.off;var t=j.Model=function(b,a){var d,c=b||{};a&&a.collection&&(this.collection=a.collection);this.attributes={};this._escapedAttributes={};this.cid=i.uniqueId("c");this.changed={};this._changes={};this._pending={};a&&a.parse&&(c=this.parse(c));if(d=i.result(this,"defaults"))c=i.extend({},d,c);this.set(c,{silent:!0});this.changed=
{};this._changes={};this._pending={};this._previousAttributes=i.clone(this.attributes);this.initialize.apply(this,arguments)};i.extend(t.prototype,e,{changed:null,_changes:null,_pending:null,_changing:null,idAttribute:"id",initialize:function(){},toJSON:function(){return i.clone(this.attributes)},sync:function(){return j.sync.apply(this,arguments)},get:function(b){return this.attributes[b]},escape:function(b){var a;if(a=this._escapedAttributes[b])return a;a=this.get(b);return this._escapedAttributes[b]=
i.escape(null==a?"":""+a)},has:function(b){return null!=this.get(b)},set:function(b,a,d){var c,e;if(null==b)return this;i.isObject(b)?(e=b,d=a):(e={})[b]=a;var b=d&&d.silent,h=d&&d.unset;e instanceof t&&(e=e.attributes);if(h)for(c in e)e[c]=void 0;if(!this._validate(e,d))return!1;this.idAttribute in e&&(this.id=e[this.idAttribute]);var j=this._changing,m=this.attributes,o=this._escapedAttributes,f=this._previousAttributes||{};for(c in e){a=e[c];if(!i.isEqual(m[c],a)||h&&i.has(m,c))delete o[c],this._changes[c]=
!0;h?delete m[c]:m[c]=a;!i.isEqual(f[c],a)||i.has(m,c)!==i.has(f,c)?(this.changed[c]=a,b||(this._pending[c]=!0)):(delete this.changed[c],delete this._pending[c],j||delete this._changes[c]);j&&i.isEqual(m[c],j[c])&&delete this._changes[c]}b||this.change(d);return this},unset:function(b,a){a=i.extend({},a,{unset:!0});return this.set(b,null,a)},clear:function(b){b=i.extend({},b,{unset:!0});return this.set(i.clone(this.attributes),b)},fetch:function(b){var b=b?i.clone(b):{},a=this,c=b.success;b.success=
function(d,e,i){if(!a.set(a.parse(d,i),b))return!1;c&&c(a,d,b)};return this.sync("read",this,b)},save:function(b,a,c){var d,e,h;null==b||i.isObject(b)?(d=b,c=a):null!=b&&((d={})[b]=a);c=c?i.clone(c):{};if(c.wait){if(!this._validate(d,c))return!1;e=i.clone(this.attributes)}b=i.extend({},c,{silent:!0});if(d&&!this.set(d,c.wait?b:c)||!d&&!this._validate(null,c))return!1;var j=this,m=c.success;c.success=function(b,a,g){h=!0;a=j.parse(b,g);c.wait&&(a=i.extend(d||{},a));if(!j.set(a,c))return!1;m&&m(j,b,
c)};a=this.sync(this.isNew()?"create":"update",this,c);!h&&c.wait&&(this.clear(b),this.set(e,b));return a},destroy:function(b){var b=b?i.clone(b):{},a=this,c=b.success,d=function(){a.trigger("destroy",a,a.collection,b)};b.success=function(e){(b.wait||a.isNew())&&d();c&&c(a,e,b)};if(this.isNew())return b.success(),!1;var e=this.sync("delete",this,b);b.wait||d();return e},url:function(){var b=i.result(this,"urlRoot")||i.result(this.collection,"url")||z();return this.isNew()?b:b+("/"===b.charAt(b.length-
1)?"":"/")+encodeURIComponent(this.id)},parse:function(b){return b},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},change:function(b){var a=this._changing,c=this._changing={},d;for(d in this._changes)this._pending[d]=!0;var e=this._changes;this._changes={};var h=[];for(d in e)c[d]=this.get(d),h.push(d);for(var e=0,j=h.length;e<j;e++)this.trigger("change:"+h[e],this,c[h[e]],b);if(a)return this;for(;!i.isEmpty(this._pending);){this._pending={};
this.trigger("change",this,b);for(d in this.changed)!this._pending[d]&&!this._changes[d]&&delete this.changed[d];this._previousAttributes=i.clone(this.attributes)}this._changing=null;return this},hasChanged:function(b){return null==b?!i.isEmpty(this.changed):i.has(this.changed,b)},changedAttributes:function(b){if(!b)return this.hasChanged()?i.clone(this.changed):!1;var a,c=!1,d=this._previousAttributes,e;for(e in b)if(!i.isEqual(d[e],a=b[e]))(c||(c={}))[e]=a;return c},previous:function(b){return null==
b||!this._previousAttributes?null:this._previousAttributes[b]},previousAttributes:function(){return i.clone(this._previousAttributes)},isValid:function(b){return!this.validate||!this.validate(this.attributes,b)},_validate:function(b,a){if(a&&a.silent||!this.validate)return!0;var b=i.extend({},this.attributes,b),c=this.validate(b,a);if(!c)return!0;a&&a.error&&a.error(this,c,a);this.trigger("error",this,c,a);return!1}});var u=j.Collection=function(b,a){a||(a={});a.model&&(this.model=a.model);void 0!==
a.comparator&&(this.comparator=a.comparator);this._reset();this.initialize.apply(this,arguments);b&&(a.parse&&(b=this.parse(b)),this.reset(b,{silent:!0,parse:a.parse}))};i.extend(u.prototype,e,{model:t,initialize:function(){},toJSON:function(b){return this.map(function(a){return a.toJSON(b)})},sync:function(){return j.sync.apply(this,arguments)},add:function(b,a){var c,d,e,j=a&&a.at,b=i.isArray(b)?b.slice():[b];c=0;for(d=b.length;c<d;c++)if(!(b[c]=this._prepareModel(b[c],a)))throw Error("Can't add an invalid model to a collection");
for(c=b.length-1;0<=c;c--)d=b[c],(e=null!=d.id&&this._byId[d.id])||this._byCid[d.cid]?(a&&a.merge&&e&&e.set(d,a),b.splice(c,1)):(d.on("all",this._onModelEvent,this),this._byCid[d.cid]=d,null!=d.id&&(this._byId[d.id]=d));this.length+=b.length;c=[null!=j?j:this.models.length,0];h.apply(c,b);o.apply(this.models,c);this.comparator&&null==j&&this.sort({silent:!0});if(a&&a.silent)return this;for(;d=b.shift();)d.trigger("add",d,this,a);return this},remove:function(b,a){var c,d,e,h;a||(a={});b=i.isArray(b)?
b.slice():[b];c=0;for(d=b.length;c<d;c++)if(h=this.getByCid(b[c])||this.get(b[c]))delete this._byId[h.id],delete this._byCid[h.cid],e=this.indexOf(h),this.models.splice(e,1),this.length--,a.silent||(a.index=e,h.trigger("remove",h,this,a)),this._removeReference(h);return this},push:function(b,a){b=this._prepareModel(b,a);this.add(b,a);return b},pop:function(b){var a=this.at(this.length-1);this.remove(a,b);return a},unshift:function(b,a){b=this._prepareModel(b,a);this.add(b,i.extend({at:0},a));return b},
shift:function(b){var a=this.at(0);this.remove(a,b);return a},slice:function(b,a){return this.models.slice(b,a)},get:function(b){return null==b?void 0:this._byId[null!=b.id?b.id:b]},getByCid:function(b){return b&&this._byCid[b.cid||b]},at:function(b){return this.models[b]},where:function(b){return i.isEmpty(b)?[]:this.filter(function(a){for(var c in b)if(b[c]!==a.get(c))return!1;return!0})},sort:function(a){if(!this.comparator)throw Error("Cannot sort a set without a comparator");i.isString(this.comparator)||
1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(i.bind(this.comparator,this));(!a||!a.silent)&&this.trigger("reset",this,a);return this},pluck:function(a){return i.invoke(this.models,"get",a)},reset:function(a,c){for(var d=0,e=this.models.length;d<e;d++)this._removeReference(this.models[d]);this._reset();a&&this.add(a,i.extend({silent:!0},c));(!c||!c.silent)&&this.trigger("reset",this,c);return this},fetch:function(a){a=a?i.clone(a):{};void 0===a.parse&&(a.parse=
!0);var c=this,d=a.success;a.success=function(e,h,i){c[a.add?"add":"reset"](c.parse(e,i),a);d&&d(c,e,a)};return this.sync("read",this,a)},create:function(a,c){var d=this,c=c?i.clone(c):{},a=this._prepareModel(a,c);if(!a)return!1;c.wait||d.add(a,c);var e=c.success;c.success=function(a,b,c){c.wait&&d.add(a,c);e&&e(a,b,c)};a.save(null,c);return a},parse:function(a){return a},clone:function(){return new this.constructor(this.models)},chain:function(){return i(this.models).chain()},_reset:function(){this.length=
0;this.models=[];this._byId={};this._byCid={}},_prepareModel:function(a,c){if(a instanceof t)return a.collection||(a.collection=this),a;c||(c={});c.collection=this;var d=new this.model(a,c);return!d._validate(d.attributes,c)?!1:d},_removeReference:function(a){this===a.collection&&delete a.collection;a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,c,d,e){("add"===a||"remove"===a)&&d!==this||("destroy"===a&&this.remove(c,e),c&&a==="change:"+c.idAttribute&&(delete this._byId[c.previous(c.idAttribute)],
null!=c.id&&(this._byId[c.id]=c)),this.trigger.apply(this,arguments))}});i.each("forEach,each,map,collect,reduce,foldl,inject,reduceRight,foldr,find,detect,filter,select,reject,every,all,some,any,include,contains,invoke,max,min,sortedIndex,toArray,size,first,head,take,initial,rest,tail,last,without,indexOf,shuffle,lastIndexOf,isEmpty".split(","),function(a){u.prototype[a]=function(){var c=m.call(arguments);c.unshift(this.models);return i[a].apply(i,c)}});i.each(["groupBy","countBy","sortBy"],function(a){u.prototype[a]=
function(c,d){var e=i.isFunction(c)?c:function(a){return a.get(c)};return i[a](this.models,e,d)}});var w=j.Router=function(a){a||(a={});a.routes&&(this.routes=a.routes);this._bindRoutes();this.initialize.apply(this,arguments)},A=/\((.*?)\)/g,B=/:\w+/g,C=/\*\w+/g,D=/[-{}[\]+?.,\\^$|#\s]/g;i.extend(w.prototype,e,{initialize:function(){},route:function(a,c,d){i.isRegExp(a)||(a=this._routeToRegExp(a));d||(d=this[c]);j.history.route(a,i.bind(function(e){e=this._extractParameters(a,e);d&&d.apply(this,e);
this.trigger.apply(this,["route:"+c].concat(e));j.history.trigger("route",this,c,e)},this));return this},navigate:function(a,c){j.history.navigate(a,c);return this},_bindRoutes:function(){if(this.routes)for(var a,c=i.keys(this.routes);null!=(a=c.pop());)this.route(a,this.routes[a])},_routeToRegExp:function(a){a=a.replace(D,"\\$&").replace(A,"(?:$1)?").replace(B,"([^/]+)").replace(C,"(.*?)");return RegExp("^"+a+"$")},_extractParameters:function(a,c){return a.exec(c).slice(1)}});var r=j.History=function(){this.handlers=
[];i.bindAll(this,"checkUrl");"undefined"!==typeof window&&(this.location=window.location,this.history=window.history)},v=/^[#\/]|\s+$/,E=/^\/+|\/+$/g,G=/msie [\w.]+/,x=/\/$/;r.started=!1;i.extend(r.prototype,e,{interval:50,getHash:function(a){return(a=(a||this).location.href.match(/#(.*)$/))?a[1]:""},getFragment:function(a,c){if(null==a)if(this._hasPushState||!this._wantsHashChange||c){var a=this.location.pathname,d=this.root.replace(x,"");a.indexOf(d)||(a=a.substr(d.length))}else a=this.getHash();
return decodeURIComponent(a.replace(v,""))},start:function(a){if(r.started)throw Error("Backbone.history has already been started");r.started=!0;this.options=i.extend({},{root:"/"},this.options,a);this.root=this.options.root;this._wantsHashChange=!1!==this.options.hashChange;this._wantsPushState=!!this.options.pushState;this._hasPushState=!(!this.options.pushState||!this.history||!this.history.pushState);var a=this.getFragment(),c=document.documentMode,c=G.exec(navigator.userAgent.toLowerCase())&&
(!c||7>=c);this.root=("/"+this.root+"/").replace(E,"/");c&&this._wantsHashChange&&(this.iframe=j.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(a));this._hasPushState?j.$(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!c?j.$(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval));this.fragment=a;a=this.location;c=a.pathname.replace(/[^\/]$/,
"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!c)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&c&&a.hash&&(this.fragment=this.getHash().replace(v,""),this.history.replaceState({},document.title,this.root+this.fragment+a.search));if(!this.options.silent)return this.loadUrl()},stop:function(){j.$(window).unbind("popstate",this.checkUrl).unbind("hashchange",
this.checkUrl);clearInterval(this._checkUrlInterval);r.started=!1},route:function(a,c){this.handlers.unshift({route:a,callback:c})},checkUrl:function(){var a=this.getFragment();a===this.fragment&&this.iframe&&(a=this.getFragment(this.getHash(this.iframe)));if(a===this.fragment)return!1;this.iframe&&this.navigate(a);this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(a){var c=this.fragment=this.getFragment(a);return i.any(this.handlers,function(a){if(a.route.test(c))return a.callback(c),
!0})},navigate:function(a,c){if(!r.started)return!1;if(!c||!0===c)c={trigger:c};a=this.getFragment(a||"");if(this.fragment!==a){this.fragment=a;var d=this.root+a;if(this._hasPushState)this.history[c.replace?"replaceState":"pushState"]({},document.title,d);else if(this._wantsHashChange)this._updateHash(this.location,a,c.replace),this.iframe&&a!==this.getFragment(this.getHash(this.iframe))&&(c.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,a,c.replace));else return this.location.assign(d);
c.trigger&&this.loadUrl(a)}},_updateHash:function(a,c,d){d?(d=a.href.replace(/(javascript:|#).*$/,""),a.replace(d+"#"+c)):a.hash="#"+c}});j.history=new r;var d=j.View=function(a){this.cid=i.uniqueId("view");this._configure(a||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()},n=/^(\S+)\s*(.*)$/,F="model,collection,el,id,attributes,className,tagName".split(",");i.extend(d.prototype,e,{tagName:"div",$:function(a){return this.$el.find(a)},initialize:function(){},render:function(){return this},
dispose:function(){this.undelegateEvents();this.model&&this.model.off&&this.model.off(null,null,this);this.collection&&this.collection.off&&this.collection.off(null,null,this);return this},remove:function(){this.dispose();this.$el.remove();return this},make:function(a,c,d){a=document.createElement(a);c&&j.$(a).attr(c);null!=d&&j.$(a).html(d);return a},setElement:function(a,c){this.$el&&this.undelegateEvents();this.$el=a instanceof j.$?a:j.$(a);this.el=this.$el[0];!1!==c&&this.delegateEvents();return this},
delegateEvents:function(a){if(a||(a=i.result(this,"events"))){this.undelegateEvents();for(var c in a){var d=a[c];i.isFunction(d)||(d=this[a[c]]);if(!d)throw Error('Method "'+a[c]+'" does not exist');var e=c.match(n),h=e[1],e=e[2],d=i.bind(d,this),h=h+(".delegateEvents"+this.cid);""===e?this.$el.bind(h,d):this.$el.delegate(e,h,d)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(a){this.options&&(a=i.extend({},this.options,a));i.extend(this,i.pick(a,F));
this.options=a},_ensureElement:function(){if(this.el)this.setElement(i.result(this,"el"),!1);else{var a=i.extend({},i.result(this,"attributes"));this.id&&(a.id=i.result(this,"id"));this.className&&(a["class"]=i.result(this,"className"));this.setElement(this.make(i.result(this,"tagName"),a),!1)}}});var y={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};j.sync=function(a,c,d){var e=y[a];i.defaults(d||(d={}),{emulateHTTP:j.emulateHTTP,emulateJSON:j.emulateJSON});var h={type:e,dataType:"json"};
d.url||(h.url=i.result(c,"url")||z());if(!d.data&&c&&("create"===a||"update"===a))h.contentType="application/json",h.data=JSON.stringify(c);d.emulateJSON&&(h.contentType="application/x-www-form-urlencoded",h.data=h.data?{model:h.data}:{});if(d.emulateHTTP&&("PUT"===e||"DELETE"===e)){h.type="POST";d.emulateJSON&&(h.data._method=e);var m=d.beforeSend;d.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",e);if(m)return m.apply(this,arguments)}}"GET"!==h.type&&!d.emulateJSON&&(h.processData=
!1);var o=d.success;d.success=function(a,b,e){o&&o(a,b,e);c.trigger("sync",c,a,d)};var n=d.error;d.error=function(a){n&&n(c,a,d);c.trigger("error",c,a,d)};return j.ajax(i.extend(h,d))};j.ajax=function(){return j.$.ajax.apply(j.$,arguments)};t.extend=u.extend=w.extend=d.extend=r.extend=function(a,c){var d=this,e;e=a&&i.has(a,"constructor")?a.constructor:function(){d.apply(this,arguments)};i.extend(e,d,c);var h=function(){this.constructor=e};h.prototype=d.prototype;e.prototype=new h;a&&i.extend(e.prototype,
a);e.__super__=d.prototype;return e};var z=function(){throw Error('A "url" property or function must be specified');}}).call(this);DefaceitHome=window.DefaceitHome||!1;Defaceit=window.Defaceit||{};Defaceit.wait=function(a,c,e,h){var e=e||this,h=h||[],m=setInterval(function(){if(0<Defaceit.load.wait.length)for(var o=0;o<Defaceit.load.wait.length;o++)if("Ok"!=Defaceit.load.wait[o])return;window[a]&&(c.call(e,h),clearInterval(m))},100)};
Defaceit.load={wait:[],js:function(a){var c=document.createElement("script");c.setAttribute("src",a);document.getElementsByTagName("head")[0].appendChild(c)},css:function(a){var c=document.createElement("link");c.rel="stylesheet";c.type="text/css";c.href=a;document.getElementsByTagName("head")[0].appendChild(c)},image:function(a){this.wait=this.wait||[];var c=this.wait.length,e=document.createElement("img");e.src=a;this.wait[c]=a;document.getElementsByTagName("head")[0].appendChild(e);var h=this;
e.onload=function(){h.wait[c]="Ok"}}};Defaceit.extend=function(a,c){var e=function(){this.initialize.apply(this,arguments)};e.prototype=_.extend({},a.prototype,c);e.prototype.parent=a.prototype;return e};Defaceit.merge=function(a,c){return jQuery.merge(a,c)};Defaceit.request=function(a){var c=document.createElement("script");c.setAttribute("src",a);document.getElementsByTagName("head")[0].appendChild(c)};callbacks=[];
function request(a){var c=document.createElement("script");c.setAttribute("src",a);document.getElementsByTagName("head")[0].appendChild(c)}function defaceit(a){callback=callbacks[0];callback[0].call(callback[1],a)}Defaceit.CrossDomainRequest=function(a){this.url=a;this.create_iframe();this.create_form(a)};
Defaceit.CrossDomainRequest.prototype={create_iframe:function(){if(!document.getElementById("coaframe")){var a=document.createElement("iframe");a.name="coaframe";a.style.visibility="hidden";a.style.position="absolute";a.style.left=a.style.top="0px";a.height=width="1px";a.id="coaframe";document.getElementsByTagName("body")[0].appendChild(a)}},create_form:function(a){var c=document.getElementById("coaform");if(c){for(;c.firstChild;)c.removeChild(c.firstChild);this.form=c}else c=this.form=document.createElement("form"),
c.style.display="none",c.id="coaform",c.enctype="multipart/form-data",c.method="POST",c.action=a,c.target="coaframe",c.setAttribute("target","coaframe"),document.body.appendChild(c)},add:function(a,c){var e=document.createElement("input");e.type="hidden";e.name=a;e.value=c;this.form.appendChild(e)},request:function(a,c){this.form.submit();var e=setInterval(function(){""!=location.hash&&"#none"!=location.hash&&(a.call(c,location.hash),location.hash="none",clearInterval(e))},200)}};
Defaceit.Screen={border:10,height:function(){return jQuery(window).height()},width:function(){return jQuery(window).width()},scroll_top:function(){return jQuery(window).scrollTop()}};Defaceit.Session=function(a){this.resource=a};Defaceit.Session.prototype={sign_in:!1,check_status:function(a){this.sign_in=!0;request(this.resource+"/show",function(c){null==c.data.key&&(this.sign_in=!1);this.data=c.data;a.call(this)},this)},signed_in:function(){return this.key?!0:!1}};
Defaceit.Display={width:function(){return jQuery(window).width()},height:function(){return jQuery(window).height()}};
Defaceit.Window||(Defaceit.Window={},Defaceit.Window.Simple=function(a){this.initialize(a)},Defaceit.Window.Simple.create=function(a){return new Defaceit.Window.Simple(a)},Defaceit.Window.Simple.prototype={wnd_handler:null,wnd_container:null,content_handler:null,config:{},initialize:function(a){a=this.configure(a);this.create_window();this.apply_title(a.title);this.apply_content(a.content);this.apply_buttons(a.buttons);this.modify(a.geometry)},configure:function(a){this.config=a||{};this.config.plugins=
this.config.plugins||{};this.config.geometry=this.config.geometry||[];this.config.buttons=this.config.buttons||[];return this.config},modify:function(a){if(!a||!a.length)return!1;for(var c=0;c<a.length;c++){var e=a[c],h=e.split(":"),e=h[0],h=1<h.length?h.slice(1):[];jQuery.isFunction(e)&&e.call(this)||this[e]&&this[e].apply(this,h)}},position:function(a,c){this.config.pX=a||this.config.pX;this.config.pY=c||this.config.pY;this.wnd_handler.css({left:this.config.pX,top:this.config.pY})},create_window:function(){(this.wnd_handler=
jQuery("<div>")).addClass("dtWindow").appendTo("body");(this.wnd_container=jQuery("<div>")).addClass("dtWindowContainer").appendTo(this.wnd_handler)},apply_title:function(a){if(!a)return!1;this.title=a;a=jQuery("<div>").html(a).addClass("dtWindowTitle");a.appendTo(this.wnd_container)},apply_content:function(a){if(!a)return!1;this.content=a;return this.content_handler&&this.content_handler.html(this.content)||(this.content_handler=jQuery("<div>").addClass("dtWindowContent").html(a).appendTo(this.wnd_container))},
apply_buttons:function(a){function c(a){var c=jQuery("<a>").attr("href","#").addClass("dtWindowButton").html(a.text);a.handler&&c.click(function(){a.handler.call(h);return!1});a.text&&c.attr("value",a.text);return c}if(!a||!a.length)return!1;for(var e=this.button_handler=jQuery("<div>").addClass("dtWindowButtons"),h=this,m=0;m<a.length;m++)e.append(c(a[m]));e.appendTo(this.wnd_container)},hide:function(){this.wnd_handler.hide()},show:function(){this.wnd_handler.show()},width:function(a){this.config.width=
parseInt(a||this.config.width);this.config.width&&this.wnd_handler.css({width:this.config.width})},height:function(a){this.config.height=parseInt(a||this.config.height);this.config.height&&this.wnd_handler.css({height:this.config.height})},fit_to_screen:function(){this.height(Defaceit.Screen.height()-2*Defaceit.Screen.border);this.width(Defaceit.Screen.width()-2*Defaceit.Screen.border);this.wnd_container.css({height:this.wnd_handler.height()-40,padding:20});var a=this.button_handler?this.button_handler.height():
0;this.content_handler.css({height:this.wnd_container.height()-a})},size:function(){this.wnd_container.css({width:this.width,height:this.height})},center:function(){this.config.pX=Math.floor(Defaceit.Screen.width()/2-this.wnd_handler.width()/2);this.config.pY=Math.floor(Defaceit.Screen.height()/2-this.wnd_handler.height()/2);this.position()},deltaXY:function(a,c){a=parseInt(a||0);c=parseInt(c||0);this.config.pX+=a;this.config.pY+=c;this.position()},top:function(){this.config.pY=Defaceit.Screen.border;
this.position()},right:function(){this.config.pX=Defaceit.Screen.width()-this.wnd_handler.width()-Defaceit.Screen.border;this.position()},left:function(){this.config.pX=Defaceit.Screen.border;this.position()},activate:function(){Defaceit.Window.Manager.get_active_window().deactivate();Defaceit.Window.Manager.active=this.nth;this.state=this.show_menu;this.wnd_handler.animate({width:this.width,height:this.height,left:this.width/2,top:this.height/2},"fast");this.wnd_handler.html(this.content)},deactivate:function(){Defaceit.Window.Manager.active=
-1;this.state=this.activate;this.wnd_handler.animate({width:50,height:50,left:this.init_position_x,top:this.init_position_y},"fast");this.wnd_handler.html(this.icon)},show_menu:function(){this.menu=this.menu||jQuery("<div>").addClass("menu").appendTo(this.wnd_handler).html('<a href="#">\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c</a><a href="#">\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c</a><a href="#">\u0423\u0434\u0430\u043b\u0438\u0442\u044c</a>');this.menu.animate({width:"20%"},
"fast");this.state=this.hide_menu},hide_menu:function(){this.menu.animate({width:"0%"},"fast");this.state=this.show_menu}},Defaceit.Window.InputBox=Defaceit.extend(Defaceit.Window.Simple,{configure:function(a){a.handler=a.handler||function(){alert("\u041e\u0431\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \u043d\u0435 \u0437\u0430\u0434\u0430\u043d")};this.textarea=jQuery("<TEXTAREA>").addClass("dtWindowInputBoxTextarea");a.content=this.textarea;
a.buttons=[{text:"\u041e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c",handler:a.handler},{text:"\u0417\u0430\u043a\u0440\u044b\u0442\u044c",handler:function(){this.wnd_handler.remove()}}];return this.parent.configure(a)},message:function(){return this.textarea.val()}}),Defaceit.Window.Manager={collection:[],create:function(a,c){return new (Defaceit.Window[a]||Defaceit.Window.Simple)(c)},add:function(a){this.collection.push(a);return this.collection.length},get:function(a){return this.collection[a]},
get_active_window:function(){return 0<=Defaceit.Window.Manager.active?this.get(Defaceit.Window.Manager.active):{deactivate:function(){}}}});
Defaceit.Queue||(Defaceit.Queue=function(a){if(this==Defaceit)return a=a||"",Defaceit.Queue.list[a]=Defaceit.Queue.list[a]||new Defaceit.Queue(a),Defaceit.Queue.list[a];this.init(a);return this},Defaceit.Queue.prototype={queue:"",call_id:1,init:function(a){this.queue=a},next_call_id:function(){return this.call_id++},list:function(){this.request("list");return this},push:function(a){return this.request("push",encodeURIComponent(a))},top:function(){this.request("top");return this},last:function(){return this.request("last")},
request:function(a,c){var c=c||"",e=this.next_call_id();1024<c.length?cors_post("http://eservices.sandbox.defaceit.ru/queue/"+a+"/"+this.queue+"/"+e,"message_text="+encodeURIComponent(c)):Defaceit.request("http://eservices.sandbox.defaceit.ru/queue/"+a+"/"+this.queue+"/"+e+"/"+c);return e},client:function(a){this.clients=this.clients||[];this.clients.push(a)},client_callback:function(a){a.call_id=parseInt(a.call_id);switch(a.type){case "messages":for(var c=0;c<a.data.length;c++)this.send_message(a.data[c].message_text,
a.data[c]);break;case "message":this.send_message(a.data.message_text,a.data,a);break;case "status":this.send_status_message(a)}},send_status_message:function(a){for(var c=0;c<this.clients.length;c++){var e=this.clients[c];e.queue_status&&e.queue_status(a)}},send_message:function(a,c,e){for(var a=decodeURIComponent(a),h=0;h<this.clients.length;h++){var m=this.clients[h];m.queue_message&&m.queue_message(a,c,e)}}},Defaceit.Queue.list=Defaceit.Queue.list||{},Defaceit.Queue.callbacks=Defaceit.Queue.callbacks||
[],Defaceit.Queue.response=function(a){Defaceit.Queue.list[a.queue_name].client_callback(a)});actions={};fire=function(a,c,e,h){actions[a]&&actions[a][c]&&actions[a][c][0]&&actions[a][c][0].call(actions[a][c][1],e,h)};function q(a,c){Defaceit.Queue(a).client({queue_message:function(c,h){fire(a,"message",c,h)},queue_status:function(c){fire(a,c.result,c,c)}});actions[a]=actions[a]||{};return{on:function(e,h){actions[a][e]=[c[h],c];return this}}}
function cors_post(a,c){var e=function(a,c){var e=new XMLHttpRequest;"withCredentials"in e?e.open(a,c,!0):"undefined"!=typeof XDomainRequest?(e=new XDomainRequest,e.open(a,c)):e=null;return e}("POST",a);if(!e)throw Error("CORS not supported");e.setRequestHeader("Content-type","application/x-www-form-urlencoded");e.setRequestHeader("Content-length",c.length);e.setRequestHeader("Connection","close");e.onload=function(){eval(e.responseText)};e.onerror=function(){console.log("There was an error!")};e.send(c)}
window.jQuery||Defaceit.load.js("http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js");Defaceit.load.css("http://sandbox.defaceit.ru/defaceit/tools/css/defaceit.css");Defaceit.load.css("http://sandbox.defaceit.ru/defaceit/bookshelf/css/bookshelf.css");DefaceitHome&&Defaceit.load.css("http://sandbox.defaceit.ru/defaceit/tools/css/home.css");Defaceit.Bookshelf=function(a,c,e){this.init(a,c,e)};
Defaceit.Bookshelf.prototype={init:function(a,c,e){this.cb=c;this.scope=e||this;this.itemCount=0;this.queue=a;this.wnd=null},render_template:function(a){this.itemCount=0;this.wnd=Defaceit.Window.Manager.create("Simple",{content:a,buttons:[{text:"\u0417\u0430\u043a\u0440\u044b\u0442\u044c",handler:function(){this.wnd_handler.remove();return!1}}],geometry:["width:800","center","show"]});Defaceit.Queue("items."+this.queue).list();bookshelfLoading=!1},render_items:function(a){0==this.itemCount%3&&(this.div=
jQuery("<div>").addClass("line").appendTo(jQuery("#bookshelf .page")));this.itemCount++;var c="",e="",h=[];(h=a.match(/^([^ ]*) (.*)$/))?(c=h[1],e=h[2]):c=a;var m=this;this.div.append(jQuery("<img>").attr("src",c).click(function(){m.cb.call(m.scope,e);return false}))},error:function(){alert("\u041e\u0447\u0435\u0440\u0435\u0434\u044c \u043f\u0443\u0441\u0442\u0430")}};
bookshelf=function(a,c,e){Defaceit.bookshelfInstance||(c=Defaceit.bookshelfInstance=new Defaceit.Bookshelf(a,c,e),q("default.bookshelf.template.sandbox.defaceit.ru",c).on("empty","error").on("message","render_template"),q("items."+a,c).on("empty","error").on("message","render_items"));Defaceit.Queue("default.bookshelf.template.sandbox.defaceit.ru").list()};bookshelfLoading=!1;
function start(){if(jQuery("#bookshelf").length||bookshelfLoading)return!1;bookshelfLoading=!0;bookshelf("bookshelf.sandbox.defaceit.ru",function(a){Defaceit.Window.Manager.create("Simple",{content:a,buttons:[{text:"\u0417\u0430\u043a\u0440\u044b\u0442\u044c",handler:function(){this.wnd_handler.remove();return!1}}],geometry:["center","show"]})})}/http:\/\/.defaceit\.ru\/defaceit\/bookshelf\/develop/.test(document.location)&&Defaceit.wait("jQuery",start,this,["jQuery"]);Defaceit.load.css("http://sandbox.defaceit.ru/defaceit/babycalc/css/babycalc.css");Defaceit.load.css("http://sandbox.defaceit.ru/defaceit/tools/css/home.css");Defaceit.Page={};namespace=function(){return Defaceit.Page.name+"."+Defaceit.Page.namespace};_.templateSettings={interpolate:/\{\{(.+?)\}\}/g};Blocks={};
Defaceit.HtmlPageBlock=Backbone.Model.extend({initialize:function(a){this.name(a);this.visible=!0;this.queueStore=new Defaceit.RWCollection;this.queueStore.on("status:change",this.route,this);this.on("status:change",this.route,this);this.status("start")},name:function(a){a&&(this.set("name",a),this.trigger("block:changed"));return this.get("name")},route:function(){switch("BLOCK:"+this.status()+", STORE:"+(this.queueStore&&this.queueStore.status())){case "BLOCK:start, STORE:start":case "BLOCK:start, STORE:ready":this.status("ready");
break;case "BLOCK:save, STORE:ready":this.trigger("save",this);this.status("ready");break;case "BLOCK:edit, STORE:start":case "BLOCK:edit, STORE:ready":this.edit();break;case "BLOCK:sync, STORE:update":this.save()}},edit:function(){alert("You should specify Edit function")},save:function(){Backbone.Model.prototype.save.call(this);this.status("save")},status:function(a,c){if(a)this.myStatus=a,(void 0==c||c)&&this.trigger("status:change");else return this.myStatus},toObject:function(){return{}}});
Defaceit.HtmlPageBlock.MenuItemView=Backbone.View.extend({tagName:"div",className:"blockMenuItem",events:{click:"open"},open:function(){this.htmlPageBlock.status("edit")},initialize:function(a){this.htmlPageBlock=a;a.on("block:changed",this.render,this)},render:function(){this.$el.html(this.htmlPageBlock.name());return this}});
Blocks.SimplePage=Defaceit.HtmlPageBlock.extend({initialize:function(){Defaceit.HtmlPageBlock.prototype.initialize.apply(this,["SimplePage"])},edit:function(){this.template=new Defaceit.Template("content_page");this.template.on("status:change",this.run,this)},run:function(){if("ready"==this.template.status()){var a=new Defaceit.BlockManager.View(this.template.get("words")),c=this;a.render();a.blocks.on("save",function(){var e=new Defaceit.BlockManager.EditView,h=_.template(c.template.get("text"),
a.blocks.toObject()),h=h.replace(RegExp("\n","g"),"<br />\n");e.render(h,Defaceit.Page.name)})}}});
Blocks.Default=Defaceit.HtmlPageBlock.extend({initialize:function(a){Defaceit.HtmlPageBlock.prototype.initialize.apply(this,[a]);this.queueNamespace="default."+Defaceit.Page.namespace;this.queueStore=new Defaceit.StackQueueStore(a,this.queueNamespace);this.queueStore.on("status:change",this.route,this);this.fetch()},edit:function(a){null===a?this.status("ready"):_.isString(a)?(this.status("sync",!1),this.fill(a)):this.edit(prompt(this.name()+":",this.queueStore.data))},fill:function(a){this.queueStore.set(a)},
toObject:function(){return this.queueStore.data}});Blocks.PageUrl=Blocks.Default.extend({initialize:function(){this.visible=!1;this.name("PageUrl");this.queueStore={read:function(){},write:function(){},status:function(){return"ready"}}},status:function(){return"ready"},edit:function(){alert("PageUrl \u043d\u0435\u0438\u0437\u043c\u0435\u043d\u044f\u0435\u043c\u043e\u0435 \u043f\u043e\u043b\u0435.")},toObject:function(){return namespace()}});
Blocks.Defaults=Defaceit.HtmlPageBlock.extend({initialize:function(a){Defaceit.HtmlPageBlock.prototype.initialize.apply(this,[a]);this.queueNamespace="defaults."+Defaceit.Page.namespace;this.queueStore.add(new Defaceit.StackQueueStore("logo",this.queueNamespace));this.fetch()},edit:function(a){null===a?this.status("ready"):_.isString(a)?(this.status("sync",!1),this.fill(a)):this.edit(prompt("Logo:",this.queueStore.find("logo").data))},fill:function(a){this.queueStore.find("logo").set(a)},toObject:function(){return{logo:this.queueStore.find("logo").data}}});
Blocks.Article=Defaceit.HtmlPageBlock.extend({initialize:function(a){Defaceit.HtmlPageBlock.prototype.initialize.apply(this,[a]);this.queueNamespace="article."+namespace();this.queueStore.add(new Defaceit.StackQueueStore("title",this.queueNamespace));this.queueStore.add(new Defaceit.StackQueueStore("content",this.queueNamespace));this.fetch()},fill:function(a,c){this.queueStore.find("title").set(a);this.queueStore.find("content").set(c)},edit:function(a){if(a)this.status("sync",!1),this.fill.apply(this,
a);else(new Blocks.Article.EditView(this)).on("block:edit_done",this.edit,this)},toObject:function(){return{title:this.queueStore.find("title").data,content:this.queueStore.find("content").data}},toString:function(){return this.title+" "+this.content}});
Blocks.Article.EditView=Backbone.View.extend({el:".center",className:"panel",initialize:function(a){this.htmlPageBlock=a;this.htmlPageBlock.on("render",this.render,this);this.template=new Defaceit.Template("article","template.sandbox.defaceit.ru");this.template.on("status:change",this.render,this)},save:function(){var a=jQuery("#defaceit-article-title").val(),c=jQuery("#defaceit-article-content").val();this.htmlPageBlock.edit([a,c]);this.hide()},cancel:function(){this.htmlPageBlock.status("ready");
this.hide()},hide:function(){this.$el.html("")},render:function(){if(!("ready"!=this.template.status()||"ready"!=this.htmlPageBlock.queueStore.status())){this.$el.html(_.template(this.template.get("text"),this.htmlPageBlock));this.$el.find("#defaceit-article-title").val(this.htmlPageBlock.queueStore.find("title").data);this.$el.find("#defaceit-article-content").val(this.htmlPageBlock.queueStore.find("content").data);var a=(new Blocks.Article.PanelButtonsView).render();a.on("done",this.save,this);
a.on("cancel",this.cancel,this)}}});
Blocks.Article.PanelButtonsView=Backbone.View.extend({el:".page",events:{"click #done":"done","click #cancel":"cancel"},done:function(){this.trigger("done")},cancel:function(){this.trigger("cancel")},render:function(){this.$el.append($("<div>").addClass("blockMenuItem").attr("id","done").html("\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c"));this.$el.append($("<div>").addClass("blockMenuItem").attr("id","cancel").html("\u041e\u0442\u043c\u0435\u043d\u0430"));return this}});
Defaceit.BlockManager=Backbone.Model.extend({initialize:function(a){this.blockList={};_.isString(a)&&(a=[a]);_.each(a,this.add,this)},name:function(a){return a.replace("{{","").replace("}}","").split(".")[0]},add:function(a){var c="";_.isString(a)?(c=this.name(a),a=this.create_block_from_name(c)):c=a.name();a.on("save",this.change_status,this);this.blockList[c]=this.blockList[c]||a},change_status:function(a){this.trigger("save",a)},create_block_from_name:function(a){return Blocks[a]?new Blocks[a](a):
new Blocks.Default(a)},toObject:function(){var a={};_.each(this.blockList,function(c){a[c.name()]=c.toObject()});return a}});Defaceit.BlockManager.View=Backbone.View.extend({el:".menu",initialize:function(a){this.blocks=new Defaceit.BlockManager(a)},render:function(){var a=this;this.$el.html("");_.each(this.blocks.blockList,function(c){c.visible&&(c=(new Defaceit.HtmlPageBlock.MenuItemView(c)).render(),a.$el.append(c.el))})}});
Defaceit.BlockManager.EditView=Backbone.View.extend({tagName:"form",className:"page-form page",save:function(){this.$el.attr("method","POST").attr("action","http://sandbox.defaceit.ru/page/save").submit()},cancel:function(){},render:function(a,c){this.$el.append("<p>\u0421\u0442\u0440\u0430\u043d\u0438\u0446\u0430 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0430, \u0441\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c?</p>");this.$el.append(jQuery("<textarea>").attr("name","content").css("display",
"none").val(a));this.$el.append(jQuery("<input>").attr("name","url").attr("type","hidden").val(c));jQuery(".center").html("").append(this.$el);var e=(new Blocks.Article.PanelButtonsView).render();e.on("done",this.save,this);e.on("cancel",this.cancel,this)}});
Defaceit.Template=Backbone.Model.extend({initialize:function(a,c){this.queueStore=new Defaceit.StackQueueStore(a,c||"template.sandbox.defaceit.ru");this.status(this.queueStore.status());this.queueStore.on("status:change",this.parse,this);this.fetch()},parse:function(){if("ready"==this.queueStore.status()){var a=this.queueStore.data;this.set("text",a);a=a.match(/{{[^}]+}}/g)||[];this.set("words",_.uniq(a));this.status("ready")}},status:function(a){a&&(this.myStatus=a,this.trigger("status:change"));
return this.myStatus},render:function(a){return _.template(this.get("text"),a)}});Defaceit.MainPageView=Backbone.View.extend({el:"body",initialize:function(){this.template=new Defaceit.Template("create_page");this.template.on("status:change",this.render,this)},render:function(){"ready"==this.template.status()&&($("body").html(this.template.render({})),button=(new Defaceit.Page.BigButtonView).render())}});Backbone.old_sync=Backbone.sync;
Backbone.sync=function(a,c,e){if(c.queueStore)switch(a){case "read":c.queueStore.read();break;case "create":c.queueStore.write();break;case "update":c.queueStore.write()}else Backbone.old_sync.apply(this,[a,c,e])};Defaceit.RWCollection=function(){this.initialize()};
_.extend(Defaceit.RWCollection.prototype,{initialize:function(){this.status("start");this.storeList=[]},read:function(){_.each(this.storeList,function(a){a.read()},this)},write:function(){_.each(this.storeList,function(a){a.write()},this)},add:function(a){a.on("status:change",this.check_status,this);this.storeList.push(a)},status:function(a){if(a)this.myStatus=a,this.trigger("status:change");else return this.myStatus},check_status:function(){this.status(function(a){var c=[];_.each(a,function(a){c.push(a.status())});
c=_.uniq(c);return 1==c.length?c.pop():"wait"}(this.storeList))},find:function(a){return _.find(this.storeList,function(c){return c.field==a})}},Backbone.Events);Defaceit.QueueStore=Defaceit.extend({});
_.extend(Defaceit.QueueStore.prototype,{initialize:function(a,c){this.status("start");this.field=a;this.namespace=c||Defaceit.namespace;this.queueCallId=[];this.queue=this.full_name();Defaceit.Queue(this.full_name()).client(this)},full_name:function(){return this.field+"."+this.namespace},set:function(a,c){this.queueCallId=[];this.data=a;this.status(c||"update")},queue_message:function(a,c,e){-1!=_.indexOf(this.queueCallId,e.call_id)&&this.set(a,"ready")},status:function(a){if(a)this.myStatus=a,this.trigger("status:change");
else return this.myStatus},queue_status:function(a){"empty"==a.result?this.set("","ready"):(this.status("ready"),console.debug("\u041e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430 \u0441\u0442\u0430\u0442\u0443\u0441\u043e\u0432 \u043d\u0435 \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442\u0441\u044f"))},read:function(){throw Error("\u041d\u0435 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0430 \u0444\u0443\u043d\u043a\u0446\u0438\u044f read \u0432 QueueStore");},write:function(){throw Error("\u041d\u0435 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0430 \u0444\u0443\u043d\u043a\u0446\u0438\u044f write \u0432 QueueStore");
}},Backbone.Events);Defaceit.StackQueueStore=Defaceit.extend(Defaceit.QueueStore,{read:function(){this.queueCallId.push(Defaceit.Queue(this.full_name()).last())},write:function(){Defaceit.Queue(this.full_name()).push(this.data)}});
String.prototype.translit=function(){var a={"\u0410":"A","\u0430":"a","\u0411":"B","\u0431":"b","\u0412":"V","\u0432":"v","\u0413":"G","\u0433":"g","\u0414":"D","\u0434":"d","\u0415":"E","\u0435":"e","\u0401":"Yo","\u0451":"yo","\u0416":"Zh","\u0436":"zh","\u0417":"Z","\u0437":"z","\u0418":"I","\u0438":"i","\u0419":"Y","\u0439":"y","\u041a":"K","\u043a":"k","\u041b":"L","\u043b":"l","\u041c":"M","\u043c":"m","\u041d":"N","\u043d":"n","\u041e":"O","\u043e":"o","\u041f":"P","\u043f":"p","\u0420":"R",
"\u0440":"r","\u0421":"S","\u0441":"s","\u0422":"T","\u0442":"t","\u0423":"U","\u0443":"u","\u0424":"F","\u0444":"f","\u0425":"Kh","\u0445":"kh","\u0426":"Ts","\u0446":"ts","\u0427":"Ch","\u0447":"ch","\u0428":"Sh","\u0448":"sh","\u0429":"Sch","\u0449":"sch","\u042a":"","\u044a":"","\u042b":"Y","\u044b":"y","\u042c":"","\u044c":"","\u042d":"E","\u044d":"e","\u042e":"Yu","\u044e":"yu","\u042f":"Ya","\u044f":"ya"," ":"-",_:"-",'"':"","'":"",".":"",",":"","!":"",":":"",";":""},c="",e;for(e in a)c+=e;
c=RegExp("["+c+"]","g");e=function(c){return c in a?a[c]:""};return function(){for(var a=this.replace(c,e).replace(" ","-").toString(),m="",o=0;o<a.length;o++)-1!="QqWwEeRrTtYyUuIiOoPpAaSsDdFfGgHhJjKkLlZzXxCcVvBbNnMm-0123456789".indexOf(a.charAt(o))&&(m+=a.charAt(o));return m}}();
Defaceit.Page.ButtonView=Backbone.View.extend({tagName:"img",events:{click:"run"},hide:function(){this.$el.hide()},run:function(){(new Blocks.SimplePage).edit();this.trigger("hide")},render:function(a,c){this.$el.attr("src","/images/templates/test.png").css({width:"100px",position:"absolute",left:a,top:c}).appendTo("body");return this}});
Defaceit.Page.BigButtonView=Backbone.View.extend({tagName:"div",className:"centerLayer",events:{click:"show"},hide:function(){for(var a=0;a<this.elements.length;a++)this.elements[a].hide();this.$el.css({display:"none"})},show:function(){this.elements=[];this.elements.push(new Defaceit.Page.ButtonView);this.elements.push(new Defaceit.Page.ButtonView);this.elements.push(new Defaceit.Page.ButtonView);for(var a=120,c=$("#big-button").offset(),e=$("#big-button").width()/2-50,h=$("#big-button").height()/
2-50,m=0;m<this.elements.length;m++)dX=220*Math.cos(a*Math.PI/180),dY=220*Math.sin(a*Math.PI/180),a+=40,this.elements[m].render(e+c.left+dX,h+c.top-dY),this.elements[m].on("hide",this.hide,this)},render:function(){this.$el.html('<img id="big-button" src="/images/buttons/create.png" />').appendTo("body")}});
function run(){if(!Defaceit.Page.name){var a=null;do a=prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0438\u043c\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b");while(null===a);Defaceit.Page.name=a.toLowerCase().translit()}console.debug(Defaceit.Page.namespace);mainPage=new Defaceit.MainPageView}/sandbox.defaceit.ru.*pages/.test(document.location)&&(Defaceit.Page.namespace="babywonder.ru",run());
